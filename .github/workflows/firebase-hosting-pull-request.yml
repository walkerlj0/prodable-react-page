# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting
'on':
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: '16'
      - run: npm install --legacy-peer-deps
      - name: Create .env file
        run: |
          echo "DISABLE_ESLINT_PLUGIN=true" > .env
          echo "SKIP_PREFLIGHT_CHECK=true" >> .env
          echo "GENERATE_SOURCEMAP=false" >> .env
          echo "REACT_APP_CI_BUILD=true" >> .env
          echo "NODE_OPTIONS=--max-old-space-size=4096" >> .env
          echo "REACT_APP_HEADLESS_BROWSER=true" >> .env
          echo "BROWSER=none" >> .env
      - name: Build with additional debugging
        run: |
          export NODE_ENV=production
          export CI=false
          # Add more verbose error output
          export DEBUG=true
          # Try to build with more detailed logging
          npm run build || {
            echo "Build failed, checking for problematic components..."
            # List all component files for reference
            find src -name "*.js" -type f | grep -v "test" | sort
            # Check for window/document references that might cause issues
            echo "Checking for potential window/document references causing issues:"
            grep -r "window\." --include="*.js" src/ || echo "No direct window references found"
            grep -r "document\." --include="*.js" src/ || echo "No direct document references found"
            # Exit with error to fail the workflow
            exit 1
          }
      - name: Deploy to Firebase
        if: success()
        run: |
          npm install -g firebase-tools@12.4.7
          firebase deploy --only hosting --project prodable-react-page --token "${{ secrets.FIREBASE_TOKEN }}" --non-interactive
